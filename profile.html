<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Campus Cupid ❤️ - Profile</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/compressorjs/dist/compressor.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Base Styles & Utilities */
body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
  color: #fff;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1rem;
}
.container { width: 100%; max-width: 600px; }
.navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; width: 100%; position: relative; }
.navbar i { font-size: 1.5rem; cursor: pointer; }
.menu-content { 
  display: none; 
  position: absolute; 
  right: 0; 
  top: 30px; 
  background: rgba(30,41,59,0.95); 
  border-radius: 0.5rem; 
  min-width: 150px; 
  padding: 0.5rem; 
  z-index: 100;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  animation: fadeIn 0.3s ease-in-out;
}
.menu-content a, .menu-content button { 
  display: flex;
  align-items: center;
  gap: 0.8rem;
  width: 100%; 
  padding: 0.7rem; 
  background: none; 
  border: none; 
  color: #fff; 
  text-align: left; 
  cursor: pointer; 
  border-radius: 0.4rem; 
  text-decoration: none;
}
.menu-content a:hover, .menu-content button:hover { background: rgba(255,255,255,0.1); }
.menu-item-with-badge { position: relative; }
.badge {
  position: absolute;
  top: 5px;
  right: 5px;
  background: red;
  color: #fff;
  border-radius: 50%;
  padding: 0.2rem 0.5rem;
  font-size: 0.7rem;
  min-width: 20px;
  text-align: center;
  border: 1px solid #0f172a;
  pointer-events: none;
  display: none;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Profile Header & Stats */
.profile-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem; position: relative; }
.profile-pic-container { position: relative; margin-bottom: 1rem; }
.profile-pic { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #fbbf24; transition: transform 0.3s ease; }
.profile-pic:hover { transform: scale(1.05); }
.user-icon {
  width: 150px;
  height: 150px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 4rem;
  color: #fff;
  border-radius: 50%;
  background: #475569;
  border: 4px solid #fbbf24;
}
#uploadLabel {
  position: absolute;
  bottom: 0px;
  right: 5px;
  background: #fbbf24;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1.2rem;
  color: #0f172a;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  transition: background 0.3s ease;
  z-index: 2;
}
#uploadLabel:hover { background: #f59e0b; }
#profileUpload { display: none; }
#uploadStatus {
  position:absolute;
  bottom: -25px;
  font-size: 0.8rem;
  color: #94a3b8;
  width: 100%;
  text-align: center;
}
.profile-header h1 { font-size: 2rem; margin: 0; color: #fff; text-align: center; word-break: break-word; }
.profile-header p { color: #bbb; margin: 0.3rem 0; font-size: 0.9rem; text-align: center; }
.profile-stats { display: flex; justify-content: space-around; width: 100%; margin-bottom: 1.5rem; }
.profile-stats .stat { background: rgba(255,255,255,0.08); backdrop-filter: blur(10px); border-radius: 0.75rem; padding: 0.6rem 0.8rem; text-align: center; flex: 1; margin: 0 0.3rem; }
.profile-stats .stat p { margin: 0; font-weight: bold; font-size: 1.2rem; color: #fbbf24; }
.profile-stats .stat span { display: block; font-size: 0.85rem; color: #94a3b8; }

/* View & Edit Sections */
.view-profile, .edit-profile { display: flex; flex-direction: column; gap: 1rem; padding: 0.5rem; }
.profile-card { display: flex; justify-content: space-between; background: rgba(255,255,255,0.08); backdrop-filter: blur(10px); padding: 1rem; border-radius: 0.75rem; }
.profile-card span { font-size: 0.9rem; color: #94a3b8; }
.profile-card p {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 500;
  text-align: right;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 0.5rem;
}
.profile-card p i { color: #fbbf24; font-size: 1rem; }
#view-bio { white-space: pre-wrap; text-align: left; max-height: 150px; overflow-y: auto; }
.interests-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0; justify-content: flex-end; }
.interest-tag {
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  padding: 0.4rem 0.8rem;
  border-radius: 1.5rem;
  font-size: 0.85rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}
.interest-tag i { color: #fbbf24; }
#edit-profile { display: none; flex-direction: column; gap: 1rem; padding: 0.5rem; }
.profile-info { display: flex; flex-direction: column; gap: 0.8rem; width: 100%; }
.profile-info input, .profile-info select, .profile-info textarea { width: 100%; padding: 0.6rem; border-radius: 0.5rem; border: 1px solid #475569; font-size: 1rem; background: #1e293b; color: #fff; }
.profile-info textarea { resize: vertical; }
button#saveBtn, button#cancelBtn { margin-top: 0.5rem; width: 100%; border: none; padding: 0.7rem; font-weight: bold; cursor: pointer; border-radius: 0.5rem; font-size: 1rem; }
button#saveBtn { background: #fbbf24; }
button#saveBtn:hover { background: #f59e0b; }
button#cancelBtn { background: #475569; margin-top: 0.5rem; }
button#cancelBtn:hover { background: #334155; }

/* Lazy Loading & Placeholder */
.placeholder-content {
  background: #334155;
  border-radius: 0.5rem;
  height: 20px;
  animation: pulse 1.5s infinite ease-in-out;
}
@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}
.placeholder-heading { width: 80%; height: 30px; margin-bottom: 0.5rem; }
.placeholder-bio { height: 60px; }
</style>
</head>
<body>
<div class="container">
  <div class="navbar">
    <i class="fa-solid fa-heart-circle-bolt" style="color:#ef4444;"></i>
    <div class="menu">
      <i class="fa-solid fa-bars" id="menuBtn"></i>
      <div class="menu-content" id="menuContent">
        <a href="feed.html"><i class="fa-solid fa-house"></i> Feed</a>
        <a href="chat.html"><i class="fa-solid fa-comments"></i> Chat</a>
        <a href="notifications.html" class="menu-item-with-badge">
          <i class="fa-solid fa-bell"></i> Notifications
          <span class="badge" id="notificationBadge">0</span>
        </a>
        <button id="editProfileMenuBtn"><i class="fa-solid fa-user-edit"></i> Edit Profile</button>
        <button id="logoutBtn"><i class="fa-solid fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
  </div>

  <div class="profile-header">
    <div class="profile-pic-container">
      <div id="profileImageContainer">
        <div class="user-icon"><i class="fa-solid fa-spinner fa-spin"></i></div>
      </div>
      <label for="profileUpload" id="uploadLabel" style="display:none;"><i class="fa-solid fa-plus"></i></label>
      <input type="file" id="profileUpload" accept="image/*">
      <div id="uploadStatus"></div>
    </div>
    <h1 id="view-fullName-header"><div class="placeholder-content placeholder-heading"></div></h1>
    <p id="view-email-header"><div class="placeholder-content" style="width: 70%;"></div></p>
  </div>

  <div id="profile-stats" class="profile-stats">
    <div class="stat"><p id="friends-count"><div class="placeholder-content"></div></p><span>Friends</span></div>
    <div class="stat"><p id="posts-count"><div class="placeholder-content"></div></p><span>Posts</span></div>
    <div class="stat"><p id="likes-count"><div class="placeholder-content"></div></p><span>Likes</span></div>
  </div>

  <div id="view-profile" class="view-profile">
    <div class="profile-card"><span>Gender</span><p id="view-gender"><div class="placeholder-content" style="width: 50%;"></div></p></div>
    <div class="profile-card"><span>Age</span><p id="view-age"><div class="placeholder-content" style="width: 30%;"></div></p></div>
    <div class="profile-card"><span>Bio</span><p id="view-bio"><div class="placeholder-content placeholder-bio" style="width: 100%;"></div></p></div>
    <div class="profile-card"><span>Interests</span><div class="interests-container" id="view-interests"><div class="placeholder-content" style="width: 60px; height: 25px;"></div><div class="placeholder-content" style="width: 80px; height: 25px;"></div></div></div>
    <button id="loveBtn" style="background:#ef4444; color:#fff; border:none; padding:0.7rem; border-radius:0.5rem; cursor:pointer;">
      <i class="fa-solid fa-heart"></i> Love
    </button>
  </div>

  <div id="edit-profile">
    <div class="profile-info">
      <input type="text" id="fullName" placeholder="Full Name">
      <div style="display:flex; gap:0.5rem;">
        <select id="gender"><option value="">Gender</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select>
        <select id="age"><option value="">Age</option></select>
      </div>
      <select id="interests" multiple>
        <option value="coding">Coding</option>
        <option value="reading">Reading</option>
        <option value="sports">Sports</option>
        <option value="movies">Movies</option>
        <option value="music">Music</option>
        <option value="travel">Travel</option>
        <option value="gaming">Gaming</option>
      </select>
      <textarea id="bio" rows="3" placeholder="Bio"></textarea>
      <button id="saveBtn">Save Profile</button>
      <button id="cancelBtn">Cancel</button>
    </div>
  </div>
</div>

<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;">
  <img id="modalImage" style="max-width:90%; max-height:90%; object-fit:contain;">
  <span id="closeModal" style="position:absolute; top:20px; right:30px; color:#fff; font-size:2rem; cursor:pointer;">&times;</span>
</div>

<script>
const SUPABASE_URL = "https://vfbjwkfurleatfdrabdg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmYmp3a2Z1cmxlYXRmZHJhYmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjAwNDIsImV4cCI6MjA3Mjk5NjA0Mn0.hguIfyynGc19tsSm9u66qy5IeUv40_mE8-JBjqnOQBE";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const viewProfile = document.getElementById("view-profile");
const editProfile = document.getElementById("edit-profile");
const uploadLabel = document.getElementById("uploadLabel");
const profileImageContainer = document.getElementById("profileImageContainer");
const profileUploadEl = document.getElementById("profileUpload");
const uploadStatusEl = document.getElementById("uploadStatus");

const fullNameEl = document.getElementById("fullName");
const genderEl = document.getElementById("gender");
const ageEl = document.getElementById("age");
const bioEl = document.getElementById("bio");
const interestsEl = document.getElementById("interests");

const viewFullNameEl = document.getElementById("view-fullName-header");
const viewEmailEl = document.getElementById("view-email-header");
const viewGenderEl = document.getElementById("view-gender");
const viewAgeEl = document.getElementById("view-age");
const viewBioEl = document.getElementById("view-bio");
const viewInterestsEl = document.getElementById("view-interests");
const likesCountEl = document.getElementById("likes-count");
const notificationBadge = document.getElementById("notificationBadge");

const imageModal = document.getElementById("imageModal");
const modalImage = document.getElementById("modalImage");
const closeModal = document.getElementById("closeModal");

const loveBtn = document.getElementById("loveBtn");

const interestIcons = {
  "coding": "fa-solid fa-code",
  "reading": "fa-solid fa-book",
  "sports": "fa-solid fa-futbol",
  "movies": "fa-solid fa-film",
  "music": "fa-solid fa-music",
  "travel": "fa-solid fa-plane",
  "gaming": "fa-solid fa-gamepad"
};

// Menu toggle
document.getElementById("menuBtn").addEventListener("click", () => {
  const menu = document.getElementById("menuContent");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
});

// Edit Profile toggle
document.getElementById("editProfileMenuBtn").addEventListener("click", () => {
  toggleEditMode(true);
});

// The fix for the cancel button: attached once
document.getElementById("cancelBtn").addEventListener("click", () => {
  loadProfile();
  toggleEditMode(false);
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "index.html";
});

// Fill age select
for (let i = 16; i <= 60; i++) {
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = i;
  ageEl.appendChild(opt);
}

// Toggle view/edit mode
function toggleEditMode(isEditing) {
  if (isEditing) {
    viewProfile.style.display = "none";
    editProfile.style.display = "flex";
    uploadLabel.style.display = "flex";
  } else {
    viewProfile.style.display = "flex";
    editProfile.style.display = "none";
    uploadLabel.style.display = "none";
  }
}

// Function to fetch and display unread notifications count
async function fetchNotifications() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { count, error } = await supabase
        .from('notifications')
        .select('*', { count: 'exact', head: true })
        .eq('recipient_id', user.id)
        .eq('read_status', false);

    if (error) {
        console.error("Error fetching notifications:", error);
        return;
    }

    if (count > 0) {
        notificationBadge.textContent = count;
        notificationBadge.style.display = 'block';
    } else {
        notificationBadge.style.display = 'none';
    }
}

// Load and display profile data
async function loadProfile() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) { window.location.href = "index.html"; return; }

  // Fetch notifications
  fetchNotifications();

  // === START: Explicitly remove all placeholder-content elements ===
  document.querySelectorAll('.placeholder-content').forEach(el => el.remove());
  // === END: Explicitly remove all placeholder-content elements ===

  let { data: profileData, error: profileError } = await supabase
    .from("profiles")
    .select("*")
    .eq("user_id", user.id)
    .single();

  if (profileError && profileError.code === "PGRST116") {
    const { data: newData, error: insertError } = await supabase
      .from("profiles")
      .insert([{ user_id: user.id, full_name: "", gender: "", age: null, bio: "", interests: [], avatar_url: "" }])
      .select()
      .single();
    if (insertError) return alert("Error creating profile: " + insertError.message);
    profileData = newData;
  }
  
  const { count: postsCount } = await supabase
    .from('posts')
    .select('*', { count: 'exact', head: true })
    .eq('author_id', user.id);

  const { count: likesCount } = await supabase
    .from('profile_likes')
    .select('*', { count: 'exact', head: true })
    .eq('liked_profile_id', user.id);

  // Set real content
  viewFullNameEl.textContent = profileData.full_name || "New User";
  viewEmailEl.textContent = user.email || "";
  document.getElementById("friends-count").textContent = "0"; // Placeholder for future friend count
  document.getElementById("posts-count").textContent = postsCount || 0;
  likesCountEl.textContent = likesCount || 0;
  
  viewGenderEl.innerHTML = profileData.gender ? `<i class="fa-solid fa-${profileData.gender === 'male' ? 'mars' : profileData.gender === 'female' ? 'venus' : 'genderless'}"></i> ${profileData.gender.charAt(0).toUpperCase() + profileData.gender.slice(1)}` : "N/A";
  viewAgeEl.textContent = profileData.age || "N/A";
  viewBioEl.textContent = profileData.bio || "No bio yet.";

  viewInterestsEl.innerHTML = "";
  if (profileData.interests?.length) {
    profileData.interests.forEach(i => {
      const span = document.createElement("span");
      span.className = "interest-tag";
      span.innerHTML = `<i class="${interestIcons[i] || 'fa-solid fa-tag'}"></i> ${i}`;
      viewInterestsEl.appendChild(span);
    });
  } else {
    viewInterestsEl.textContent = "No interests added.";
  }

  // Populate form fields for edit mode
  fullNameEl.value = profileData.full_name || "";
  genderEl.value = profileData.gender || "";
  ageEl.value = profileData.age || "";
  bioEl.value = profileData.bio || "";
  if (profileData.interests) {
    for (let opt of interestsEl.options) opt.selected = profileData.interests.includes(opt.value);
  }

  // Load and display profile image, clearing initial spinner first.
  profileImageContainer.innerHTML = ''; // Clear any initial spinner or placeholder
  if (profileData.avatar_url) {
    const imgEl = document.createElement("img");
    imgEl.id = "profileImage";
    imgEl.className = "profile-pic";
    imgEl.src = profileData.avatar_url;
    imgEl.alt = "Profile Picture";
    
    imgEl.onload = () => {
        profileImageContainer.appendChild(imgEl);
    };
    imgEl.onerror = () => {
        profileImageContainer.innerHTML = `<i class="fa-solid fa-user user-icon"></i>`;
    };
    
    imgEl.style.cursor = "pointer";
    imgEl.addEventListener("click", () => {
      modalImage.src = imgEl.src;
      imageModal.style.display = "flex";
    });

  } else {
    profileImageContainer.innerHTML = `<i class="fa-solid fa-user user-icon"></i>`;
  }
  toggleEditMode(false);
}

document.getElementById("saveBtn").addEventListener("click", async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return alert("No user found");

  const selectedInterests = Array.from(interestsEl.options)
    .filter(option => option.selected)
    .map(option => option.value);

  const updates = {
    full_name: fullNameEl.value,
    gender: genderEl.value,
    age: ageEl.value,
    bio: bioEl.value,
    interests: selectedInterests
  };

  const { error } = await supabase.from("profiles").update(updates).eq("user_id", user.id);
  if (error) {
    alert("Save failed: " + error.message);
  } else {
    alert("Profile updated successfully!");
    loadProfile();
  }
});

profileUploadEl.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  uploadStatusEl.textContent = "Uploading image...";
  uploadLabel.style.display = "none";

  new Compressor(file, {
    quality: 0.6,
    maxWidth: 800,
    maxHeight: 800,
    success: async (compressedFile) => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        uploadStatusEl.textContent = "Please log in to upload an image.";
        uploadLabel.style.display = "flex";
        return;
      }
      
      const fileExt = compressedFile.name.split(".").pop();
      const fileName = `${user.id}.${fileExt}`;
      const filePath = `${user.id}/${fileName}`;
    
      const { error: uploadError } = await supabase.storage.from("avatars").upload(filePath, compressedFile, { upsert: true });

      if (uploadError) {
        uploadStatusEl.textContent = "Image upload failed: " + uploadError.message;
      } else {
        const { data: { publicUrl } } = supabase.storage.from("avatars").getPublicUrl(filePath);
        
        const newPublicUrl = `${publicUrl}?t=${new Date().getTime()}`;

        const { error: updateErr } = await supabase.from("profiles").update({ avatar_url: newPublicUrl }).eq("user_id", user.id);
        
        if (updateErr) {
          uploadStatusEl.textContent = "Failed to save avatar: " + updateErr.message;
        } else {
          profileImageContainer.innerHTML = `<img id="profileImage" class="profile-pic" src="${newPublicUrl}" alt="Profile Picture">`;
          
          const newImgEl = profileImageContainer.querySelector("#profileImage");
          newImgEl.style.cursor = "pointer";
          newImgEl.addEventListener("click", () => {
              modalImage.src = newPublicUrl;
              imageModal.style.display = "flex";
          });

          uploadStatusEl.textContent = "Profile picture updated!";
          setTimeout(() => { uploadStatusEl.textContent = ""; }, 3000);
        }
      }
      uploadLabel.style.display = "flex";
    },
    error: (err) => {
      uploadStatusEl.textContent = "Image compression failed: " + err.message;
      uploadLabel.style.display = "flex";
    },
  });
});

closeModal.addEventListener("click", () => {
  imageModal.style.display = "none";
});

loveBtn.addEventListener("click", async () => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return alert("Please log in to like a profile.");
  }
  
  const likedProfileId = user.id;

  const { error } = await supabase
    .from('profile_likes')
    .insert([
      { liker_id: user.id, liked_profile_id: likedProfileId }
    ]);

  if (error) {
    if (error.code === '23505') {
      alert("You already liked this profile.");
    } else {
      alert("Failed to like profile: " + error.message);
    }
  } 
    loadProfile();
  
});

loadProfile();
</script>
</body>
</html>
